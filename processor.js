module.exports = function(scope, matchers) {
  var attributes = scope.attributes;
  var id = scope.id;

  function checkRequest(data) {
    var match = true;
    var testKeys;

    try {
      // convert to JSON
      data = JSON.parse(data);
    }
    catch (e) {
      return false;
    }

    // get the testkeys
    testKeys = Object.keys(data).filter(function(key) {
      return key.charAt(0) !== '_';
    });

    // iterate through the test keys and look for a match
    match = testKeys.reduce(function(memo, key) {
      // check for a match
      return memo && attributes[key] === data[key];
    }, match);

    // if we have a match, then acknowledge the request
    if (match) {
      // if there are active blocks, return
      if (scope.blocks.length) {
        return scope.on('unblock', function() {
          scope.send('/to', data.__srcid, '/ackreq', data.__reqid);
        });

      }

      return scope.send('/to', data.__srcid, '/ackreq', data.__reqid);
    }

    return false;
  }

  return function(data) {
    var isMatch = true;

    // process /to messages
    if (data.slice(0, 3) === '/to') {
      isMatch = data.slice(4, id.length + 4) === id;
      if (isMatch) {
        data = data.slice(5 + id.length);
      }
    }

    // if this is not a match, then bail
    if (! isMatch) {
      return;
    }

    // check for request, um, requests
    if (data.slice(0, 8) === '/request') {
      return checkRequest(data.slice(9));
    }

    // process matchers
    scope.matchers = scope.matchers.filter(function(rule) {
      var exec = data.slice(0, rule.prefix.length) === rule.prefix;

      if (exec && typeof rule.handler == 'function') {
        rule.handler(data);
      }

      // only keep if not executed
      return !exec;
    });
  };
};